#!/usr/bin/env bash
# debug-cleanup - Clean up old debug sessions from review-code
#
# Usage:
#   debug-cleanup [options]
#
# Options:
#   --older-than DAYS    Remove sessions older than DAYS days (default: 7)
#   --all                Remove all debug sessions
#   --list               List all debug sessions with size and age
#   --help               Show this help message
#
# Examples:
#   debug-cleanup                    # Remove sessions older than 7 days
#   debug-cleanup --older-than 30    # Remove sessions older than 30 days
#   debug-cleanup --all              # Remove all sessions
#   debug-cleanup --list             # List all sessions

set -euo pipefail

# Default values
DAYS=7
DEBUG_DIR="${REVIEW_CODE_DEBUG_PATH:-$HOME/.cache/review-code/debug}"
LIST_ONLY=false
REMOVE_ALL=false

# Parse arguments
while [ $# -gt 0 ]; do
    case "$1" in
        --older-than)
            DAYS="$2"
            shift 2
            ;;
        --all)
            REMOVE_ALL=true
            shift
            ;;
        --list)
            LIST_ONLY=true
            shift
            ;;
        --help | -h)
            # Extract and print header comment
            sed -n '2,/^$/p' "$0" | sed 's/^# //; s/^#//'
            exit 0
            ;;
        *)
            echo "Error: Unknown option: $1" >&2
            echo "Use --help for usage information" >&2
            exit 1
            ;;
    esac
done

# Check if debug directory exists
if [ ! -d "$DEBUG_DIR" ]; then
    echo "No debug directory found at: $DEBUG_DIR"
    exit 0
fi

# Function to list sessions
list_sessions() {
    echo "Debug sessions in: $DEBUG_DIR"
    echo ""
    printf "%-60s %10s %15s\n" "SESSION" "SIZE" "AGE (days)"
    printf "%-60s %10s %15s\n" "$(printf '%.0s-' {1..60})" "$(printf '%.0s-' {1..10})" "$(printf '%.0s-' {1..15})"

    local total_size=0
    local total_count=0

    find "$DEBUG_DIR" -mindepth 1 -maxdepth 1 -type d | sort -r | while read -r session_dir; do
        local session_name
        session_name=$(basename "$session_dir")

        # Get size
        local size
        if command -v du > /dev/null 2>&1; then
            size=$(du -sh "$session_dir" 2> /dev/null | cut -f1)
        else
            size="unknown"
        fi

        # Get age in days
        local age_days
        if [[ "$OSTYPE" == "darwin"* ]]; then
            # macOS
            local mod_time
            mod_time=$(stat -f %m "$session_dir")
            local now
            now=$(date +%s)
            age_days=$(((now - mod_time) / 86400))
        else
            # Linux
            local mod_time
            mod_time=$(stat -c %Y "$session_dir")
            local now
            now=$(date +%s)
            age_days=$(((now - mod_time) / 86400))
        fi

        printf "%-60s %10s %15s\n" "$session_name" "$size" "$age_days"

        total_count=$((total_count + 1))
    done

    echo ""
    echo "Total sessions: $(find "$DEBUG_DIR" -mindepth 1 -maxdepth 1 -type d | wc -l | tr -d ' ')"

    # Total disk usage
    if command -v du > /dev/null 2>&1; then
        local total_size
        total_size=$(du -sh "$DEBUG_DIR" 2> /dev/null | cut -f1)
        echo "Total disk usage: $total_size"
    fi
}

# Function to remove sessions
remove_sessions() {
    local days="$1"
    local removed_count=0

    if [ "$REMOVE_ALL" = true ]; then
        echo "Removing all debug sessions..."
        rm -rf "${DEBUG_DIR:?}"/*
        removed_count=$(find "$DEBUG_DIR" -mindepth 1 -maxdepth 1 -type d 2> /dev/null | wc -l | tr -d ' ')
        echo "Removed all sessions"
    else
        echo "Removing debug sessions older than $days days..."

        # Find and remove old sessions
        if [[ "$OSTYPE" == "darwin"* ]]; then
            # macOS doesn't support -mtime with find in the same way
            find "$DEBUG_DIR" -mindepth 1 -maxdepth 1 -type d | while read -r session_dir; do
                local mod_time
                mod_time=$(stat -f %m "$session_dir")
                local now
                now=$(date +%s)
                local age_days
                age_days=$(((now - mod_time) / 86400))

                if [ "$age_days" -gt "$days" ]; then
                    echo "  Removing: $(basename "$session_dir") (${age_days} days old)"
                    rm -rf "$session_dir"
                    removed_count=$((removed_count + 1))
                fi
            done
        else
            # Linux
            while IFS= read -r session_dir; do
                echo "  Removing: $(basename "$session_dir")"
                rm -rf "$session_dir"
                removed_count=$((removed_count + 1))
            done < <(find "$DEBUG_DIR" -mindepth 1 -maxdepth 1 -type d -mtime +"$days")
        fi

        if [ "$removed_count" -eq 0 ]; then
            echo "No sessions older than $days days found"
        else
            echo "Removed $removed_count session(s)"
        fi
    fi
}

# Main logic
if [ "$LIST_ONLY" = true ]; then
    list_sessions
else
    remove_sessions "$DAYS"
fi
