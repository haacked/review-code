#!/usr/bin/env bash
# bin/manage-permissions - Manage Claude Code permissions for review-code
#
# Usage:
#   bin/manage-permissions add     # Add review-code permissions
#   bin/manage-permissions remove  # Remove review-code permissions
#   bin/manage-permissions status  # Check current permissions
#
# Description:
#   Manages review-code script permissions in ~/.claude/settings.json

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

info() {
    echo -e "${GREEN}✓${NC} $1"
}

warn() {
    echo -e "${YELLOW}⚠${NC} $1"
}

error() {
    echo -e "${RED}✗${NC} $1"
}

debug() {
    echo -e "${BLUE}→${NC} $1"
}

CLAUDE_DIR="${HOME}/.claude"
SETTINGS_FILE="${CLAUDE_DIR}/settings.json"

# Required permissions for review-code scripts
permissions=(
    "Bash(~/.claude/bin/review-code/*:*)"
    "Bash(git rev-parse:*)"
    "Read(~/.claude/**)"
)

show_usage() {
    echo "Usage: bin/manage-permissions {add|remove|status}"
    echo ""
    echo "Commands:"
    echo "  add     - Add review-code permissions to settings.json"
    echo "  remove  - Remove review-code permissions from settings.json"
    echo "  status  - Check which permissions are currently configured"
    echo ""
}

check_prerequisites() {
    if ! command -v jq &> /dev/null; then
        error "jq is required but not installed"
        echo "Install with: brew install jq"
        exit 1
    fi

    if [[ ! -d "${CLAUDE_DIR}" ]]; then
        error "Claude Code directory not found: ${CLAUDE_DIR}"
        echo "Please install Claude Code first"
        exit 1
    fi
}

create_settings_if_needed() {
    if [[ ! -f "${SETTINGS_FILE}" ]]; then
        mkdir -p "${CLAUDE_DIR}"
        echo '{"permissions":{"allow":[],"deny":[],"ask":[]}}' > "${SETTINGS_FILE}"
        info "Created new settings file"
    fi
}

cmd_add() {
    echo ""
    echo "This will add the following permissions to ${SETTINGS_FILE}:"
    echo ""
    for perm in "${permissions[@]}"; do
        echo "  - ${perm}"
    done
    echo ""
    echo "These permissions allow review-code scripts to:"
    echo "  • Read git repository metadata"
    echo "  • Analyze code diffs"
    echo "  • Load context files"
    echo ""
    echo "All operations are READ-ONLY."
    echo ""

    # Add each permission if not already present
    local added=0
    local skipped=0

    for perm in "${permissions[@]}"; do
        if jq -e ".permissions.allow | index(\"${perm}\")" "${SETTINGS_FILE}" > /dev/null 2>&1; then
            echo "  ✓ Already configured: ${perm}"
            skipped=$((skipped + 1))
        else
            if jq ".permissions.allow += [\"${perm}\"]" "${SETTINGS_FILE}" > "${SETTINGS_FILE}.tmp"; then
                mv "${SETTINGS_FILE}.tmp" "${SETTINGS_FILE}"
                echo "  + Added: ${perm}"
                added=$((added + 1))
            else
                error "Failed to add permission: ${perm}"
                rm -f "${SETTINGS_FILE}.tmp"
                exit 1
            fi
        fi
    done

    echo ""
    if [[ "${added}" -gt 0 ]]; then
        info "Added ${added} new permission(s)"
    fi
    if [[ "${skipped}" -gt 0 ]]; then
        info "${skipped} permission(s) already configured"
    fi
    echo ""
    info "Permissions configured successfully!"
    echo ""
}

cmd_remove() {
    echo ""
    echo "This will remove the following permissions from ${SETTINGS_FILE}:"
    echo ""
    for perm in "${permissions[@]}"; do
        echo "  - ${perm}"
    done
    echo ""

    # Remove each permission if present
    local removed=0
    local not_found=0

    for perm in "${permissions[@]}"; do
        if jq -e ".permissions.allow | index(\"${perm}\")" "${SETTINGS_FILE}" > /dev/null 2>&1; then
            if jq ".permissions.allow |= map(select(. != \"${perm}\"))" "${SETTINGS_FILE}" > "${SETTINGS_FILE}.tmp"; then
                mv "${SETTINGS_FILE}.tmp" "${SETTINGS_FILE}"
                echo "  - Removed: ${perm}"
                removed=$((removed + 1))
            else
                error "Failed to remove permission: ${perm}"
                rm -f "${SETTINGS_FILE}.tmp"
                exit 1
            fi
        else
            echo "  ✓ Not configured: ${perm}"
            not_found=$((not_found + 1))
        fi
    done

    echo ""
    if [[ "${removed}" -gt 0 ]]; then
        info "Removed ${removed} permission(s)"
    fi
    if [[ "${not_found}" -gt 0 ]]; then
        info "${not_found} permission(s) were not configured"
    fi
    echo ""
    info "Permissions removed successfully!"
    echo ""
}

cmd_status() {
    echo ""
    echo "Checking permissions in ${SETTINGS_FILE}:"
    echo ""

    local configured=0
    local not_configured=0

    for perm in "${permissions[@]}"; do
        if jq -e ".permissions.allow | index(\"${perm}\")" "${SETTINGS_FILE}" > /dev/null 2>&1; then
            echo "  ✓ Configured: ${perm}"
            configured=$((configured + 1))
        else
            echo "  ✗ Not configured: ${perm}"
            not_configured=$((not_configured + 1))
        fi
    done

    echo ""
    if [[ "${configured}" -eq ${#permissions[@]} ]]; then
        info "All permissions are configured"
    elif [[ "${configured}" -eq 0 ]]; then
        warn "No permissions are configured"
        echo "  Run: bin/manage-permissions add"
    else
        warn "Some permissions are missing (${not_configured} of ${#permissions[@]})"
        echo "  Run: bin/manage-permissions add"
    fi
    echo ""
}

# Main
check_prerequisites
create_settings_if_needed

command="${1:-}"

case "${command}" in
    add)
        cmd_add
        ;;
    remove)
        cmd_remove
        ;;
    status)
        cmd_status
        ;;
    "")
        # No argument - default to add for backwards compatibility
        cmd_add
        ;;
    *)
        error "Unknown command: ${command}"
        echo ""
        show_usage
        exit 1
        ;;
esac
