#!/usr/bin/env bash
#/ Usage: bin/lint [options]
#/ Description: Lints shell scripts for quality and potential issues
#/ Options:
#/   -v, --verbose  Verbose output

source bin/helpers/_utils.sh
set_source_and_root_dir
parse_common_args "$@"

print_color blue "Linting shell scripts…"

success_status=true

# Check for shellcheck
if ! command_exists shellcheck; then
    fatal "shellcheck not found - install with: brew install shellcheck"
fi

# Find all shell scripts
shell_files=(
    bin/*
    lib/*.sh
    lib/helpers/*.sh
    *.sh
)

actual_files=()
for pattern in "${shell_files[@]}"; do
    for file in $pattern; do
        if [ -f "$file" ] && [[ ! "$file" =~ \.md$ ]]; then
            # Skip non-shell files
            if [[ "$file" == *.sh ]] || [[ -x "$file" ]] && head -1 "$file" | grep -q '^#!/.*bash'; then
                actual_files+=("$file")
            fi
        fi
    done
done

if [ ${#actual_files[@]} -eq 0 ]; then
    warning "No shell scripts found to lint"
    exit 0
fi

print_color blue "Found ${#actual_files[@]} shell scripts"

# Run shellcheck with strict settings
# Exclude style-only warnings that don't affect functionality:
# - SC2250: Braces around variables (style preference)
# - SC2292: [[ ]] vs [ ] (style preference, both work fine)
# - SC2248: Quoting variables in arithmetic (style preference, not needed for numbers)
# - SC2312: Command substitution in echo/return (informational, not a bug)
# - SC2249: Missing default case (informational, not always needed)
# - SC2162: read without -r (acceptable in interactive scripts)
# - SC1091: Not following sourced files (info only, shellcheck can't follow all paths)
# - SC2310: Function in condition disables set -e (info only, intentional pattern)
# - SC2126: grep -c vs grep|wc (style preference, both work fine)
# - SC2155: Declare and assign separately (common pattern, rarely causes issues)
# - SC2016: Single quotes don't expand (info only, intentional)
# - SC2015: A && B || C pattern (info only, intentional use)
# - SC2001: sed vs parameter expansion (style preference)
if ! run_command "shellcheck -x -o all -e SC2250,SC2292,SC2248,SC2312,SC2249,SC2162,SC1091,SC2310,SC2126,SC2155,SC2016,SC2015,SC2001 ${actual_files[*]}" "Running shellcheck"; then
    success_status=false
fi

if $success_status; then
    success "Linting complete - no issues found"
else
    print_color red "✗ Linting found issues"
    exit 1
fi
