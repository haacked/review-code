name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history for git-dependent tests

    - name: Install dependencies
      run: |
        # Configure git to use 'main' as default branch
        git config --global init.defaultBranch main

        # Configure git user for CI (needed for tests that create commits)
        git config --global user.email "ci@github.com"
        git config --global user.name "GitHub CI"

        # Install system dependencies
        sudo apt-get update
        sudo apt-get install -y shellcheck

        # Install jq 1.7.1 (apt has older 1.6 which has syntax incompatibilities)
        JQ_VERSION="1.7.1"
        curl -fsSL "https://github.com/jqlang/jq/releases/download/jq-${JQ_VERSION}/jq-linux-amd64" -o /tmp/jq
        sudo install -m 755 /tmp/jq /usr/local/bin/jq

        # Install bats-core (1.11.1 includes IFS fix for test compatibility)
        sudo npm install -g bats@1.11.1

        # Verify installations
        echo "=== Dependency Versions ==="
        bash --version | head -1
        bats --version
        jq --version
        git --version
        shellcheck --version

    - name: Run tests
      run: |
        chmod +x bin/test
        bin/test

    - name: Lint shell scripts
      run: |
        chmod +x bin/lint
        bin/lint
